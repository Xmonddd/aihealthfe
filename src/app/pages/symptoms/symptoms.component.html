<section class="symptoms-page">
  <h1>Symptoms Checker</h1>

  <!-- STEP 1 -->
  <div class="panel" *ngIf="step === 1">
    <div class="step-label">Step 1: Describe your symptoms</div>

    <div class="input-row">
      <input
        #symInput
        type="text"
        [value]="inputText"
        (input)="onInputChange(symInput.value)"
        (keydown)="onInputKeydown($event)"
        (blur)="onInputBlur()"
        placeholder="Type your main symptoms here"
        aria-label="Type your main symptoms"
        [attr.aria-expanded]="showSuggestions"
        aria-autocomplete="list"
        aria-haspopup="listbox"
        [attr.aria-controls]="'sym-suggest-list'"
      />

      <!-- Suggestions dropdown (only from dataset) -->
      <div class="suggestions" *ngIf="showSuggestions">
        <ul id="sym-suggest-list" role="listbox">
          <li
            *ngFor="let s of filteredSuggestions; let i = index"
            role="option"
            [attr.aria-selected]="i === activeIndex"
            [class.active]="i === activeIndex"
            (mousedown)="selectSuggestion(s)"
          >
            {{ s }}
          </li>

          <li class="no-result" *ngIf="filteredSuggestions.length === 0">
            No results
          </li>
        </ul>
      </div>
    </div>

    <div class="selected-box" *ngIf="selectedSymptoms.length > 0">
      <div class="selected-title">Selected Symptoms</div>
      <ul class="selected-list">
        <li class="chip" *ngFor="let s of selectedSymptoms; let i = index">
          <span class="chip-text">{{ s }}</span>
          <button class="chip-close" type="button" (click)="removeSymptom(i)" aria-label="Remove symptom">Ã—</button>
        </li>
      </ul>
    </div>

    <div class="actions">
      <button
        class="btn-next"
        type="button"
        (click)="nextStep()"
        [disabled]="loading || selectedSymptoms.length === 0"
      >
        Next step
      </button>
    </div>

    <p class="error" *ngIf="error">{{ error }}</p>
  </div>

  <!-- STEP 2 -->
  <div class="panel" *ngIf="step === 2">
    <div class="step-label">Step 2: Health Details</div>

    <div class="card">
      <div class="form-grid">
        <div class="form-field">
          <label for="age">Age</label>
          <input id="age" type="number" min="0" placeholder="eg., 24" #ageInput
                 [value]="age ?? ''" (input)="onAgeInput(ageInput.value)" />
        </div>

        <div class="form-field">
          <label for="gender">Gender</label>
          <select id="gender" #genderSelect [value]="gender" (change)="onGenderChange(genderSelect.value)">
            <option value="" disabled>Select Gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
    </div>

    <div class="actions between">
      <button class="btn-back" type="button" (click)="backToStep1()">Back</button>
      <button class="btn-next" type="button" (click)="nextFromStep2()">Next step</button>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="panel" *ngIf="step === 3">
    <div class="step-label">Step 3: Review & Submit</div>
    <p class="muted">Review your information before AI analysis</p>

    <div class="review-section">
      <div class="review-title">Symptoms</div>
      <ul class="chip-row">
        <li class="chip small" *ngFor="let s of selectedSymptoms">
          <span class="chip-text">{{ s }}</span>
        </li>
      </ul>
    </div>

    <div class="review-section">
      <div class="review-title">Health Details</div>
      <div class="details-bar">
        <div class="col">
          <span class="label">Age:</span>
          <span class="value">{{ age ?? 'eg., 24' }}</span>
        </div>
        <div class="col">
          <span class="label">Gender:</span>
          <span class="value">{{ genderLabel() }}</span>
        </div>
      </div>
    </div>

    <div class="info-banner">
      <div class="info-title">Ready for AI Analysis</div>
      <div class="info-sub">This demo analyzes your symptoms using a simple ML model and rule checks. Not for diagnostic use.</div>
    </div>

    <div class="actions between">
      <button class="btn-back" type="button" (click)="backToStep2()">Back</button>
      <button class="btn-next" type="button" (click)="analyze()" [disabled]="loading">
        {{ loading ? 'Analyzing...' : 'Analyze' }}
      </button>
    </div>

    <p class="error" *ngIf="error">{{ error }}</p>
  </div>

  <!-- STEP 4: RESULTS -->
  <div class="panel" *ngIf="step === 4">
    <h2 class="center">AI Analysis Complete</h2>

    <div class="result-block" *ngIf="result">
      <div class="block-title">Conditions that match your symptoms</div>
      <div class="big-box">
        <div class="big-text">
          {{ result.topCondition || 'No specific condition detected' }}
        </div>
      </div>
    </div>

    <div class="result-block">
      <div class="block-title">Condition Details</div>
      <div class="small-box">
        {{ result?.conditionDetails || 'Keep monitoring and seek medical advice if symptoms persist.' }}
      </div>

      <div class="block-title mt">Treatment Option</div>
      <div class="big-box">
        <div class="treatment-text">{{ result?.treatment || '' }}</div>
      </div>

      <div class="block-title mt">General Advice</div>
      <div class="small-box">
        {{ result?.advice || '' }}
      </div>
    </div>

    <div class="actions center">
      <button class="btn-next" type="button" (click)="startNew()">Start new analysis</button>
    </div>
  </div>
</section>